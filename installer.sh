#!/usr/bin/env bash
# Simple script for adding additional tools to a standard Kali pentest image
# 2020 WeakNet Labs
#
# I need to be root, even SUDO works here:
if [[ $(whoami) != "root" ]]
then
	printf "This script requires root access\n";
	exit 1337
fi
COLOR="\e[38;5;130m"
ERROR="\e[38;5;196m"
RST="\x1b[0m"
errors () {
	printf "${ERROR}[ERROR]: $1 $RST\n"
	echo "$(date): $1" >> installer.log
}
export -f errors
# ---------------------
# Update:
# ---------------------
printf "$COLOR * Updating repositories $RST\n";
apt update 1>/dev/null || (errors "An internet connection is required for this script." && exit 1337)
apt -y upgrade 1>/dev/null
# ---------------------
# Install Impacket:
# ---------------------
printf "$COLOR * Installing Impacket $RST\n"
mkdir /pentest || errors "FAILED TO MAKE DIRECTORY /PENTEST"
cd /pentest && git clone https://github.com/SecureAuthCorp/impacket
cd /pentest/impacket && pip install . || (errors "FAILED TO INSTALL Impacket with PIP" && exit 1337)
# ---------------------
# Install EyeWitness:
# ---------------------
printf "$COLOR * Installing EyeWitness $RST\n"
apt install eyewitness -y
# ---------------------
# Install BloodHound:
# ---------------------
printf "$COLOR * Installing Bloodhound $RST\n"
apt install -y bloodhound
# ---------------------
# Install mitm6:
# ---------------------
printf "$COLOR * Installing MITM6 $RST\n"
cd /pentest && git clone https://github.com/fox-it/mitm6
cd /pentest/mitm6 && pip install -r requirements.txt || (errors "FAILED TO INSTALL MITM6 REQUIREMENTS" && exit 1337)
cd /pentest/mitm6 && python setup.py install || (errors "FAILED TO INSTALL MITM6" && exit 1337)
# ---------------------
# Install CrackMapExec:
# ---------------------
printf "$COLOR * Installing CrackMapExec $RST\n"
apt -y install crackmapexec
# ---------------------
# Install EavesARP:
# ---------------------
printf "$COLOR * Installing EavesARP $RST\n"
apt -y install python3-pip
cd /pentest && git clone https://github.com/arch4ngel/eavesarp
cd /pentest/eavesarp && pip3 install -r requirements.txt || (errors "FAILED TO INSTALL EAVESARP REQUIREMENTS" && exit 1337)
# ---------------------
# Install NESSUS:
# ---------------------
if [[ -f /pentest/nessus.deb ]]
then
	# file exists, check hash:
	if [[ $(md5sum /pentest/nessus.deb |awk '{print $1}') == "f0ce95ee0a2b6a0db2eb2f4f47a84b2c" ]]
	then
		# Hash OKAY, is it already installed?
		if [[ -f /opt/nessus/sbin/nessusd ]]
		then
			# Let's remove it
			apt remove --purge nessus -y 
			rm -rf /opt/nessus
		fi
	else # HASH is BAD:
		rm -rf /pentest/nessus.deb # remove the old, it's corrupt
		wget https://demonlinux.com/download/packages/Nessus-8.9.0-debian6_amd64.deb -O /pentest/nessus.deb
	fi
else
	wget https://demonlinux.com/download/packages/Nessus-8.9.0-debian6_amd64.deb -O /pentest/nessus.deb
fi
dpkg -i /pentest/nessus.deb || (errors "FAILED TO INSTAL NESSUS" && exit 1337)
apt -f install 1>/dev/null 
